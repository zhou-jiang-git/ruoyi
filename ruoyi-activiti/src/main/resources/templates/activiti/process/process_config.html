<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org"
	  xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head>
	<th:block th:include="include :: header('流程配置')" />
    <script th:src="@{/diagram-viewer/js/jstools.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/raphael.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/diagram-viewer/js/jquery/jquery.progressbar.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/jquery/jquery.asyncqueue.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/Color.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/Polyline.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/ActivityImpl.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/ActivitiRest.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/LineBreakMeasurer.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/ProcessDiagramGenerator.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/ProcessDiagramCanvas.js}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{/diagram-viewer/js/svg-pan-zoom.min.js}" type="text/javascript" charset="utf-8"></script>
    <th:block th:include="include :: ztree-css" />
    <style>
        .ibox-title{
            cursor: pointer;
        }
        .overlayBox {
            position: absolute;
            left: 20px;
            right: 430px;
            top: 20px;
            bottom: 20px;
            background: #FFF;
            border: 1px solid #ddd
        }

        .overlayBox .process-title {
            position: absolute;
            left: 21px;
            top: 0;
            height: 60px;
            font-size: 18px;
            line-height: 60px;
            color: #222;
        }

        .diagramHolder {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .diagramHolder .diagram, .diagramHolder .diagram svg {
            width: 100% !important;
            height: 100% !important;
        }

        .infoBox {
            width: 400px;
            height: 100%;
            padding: 0;
            border: 0;
            margin: 0;
            font-size: 12px;
            float: right;
            margin-top: 20px;
        }
        .config-title {
            height: 50px;
            font-size: 16px;
            line-height: 50px;
            color: #1c84c6;
            font-weight: bold;
            border: 1px solid #ddd;
            padding-left: 15px;
            background: #ffffff;
        }
        .ibox {
            margin-bottom: 10px;
        }
        .info-line {
            height: 42px;
            line-height: 42px;
        }
        .selected_user, .selected_role, selected_post {
            display: inline-block;
            height: 26px;
            border-radius: 4px;
            line-height: 26px;
            background: #FFF;
            font-size: 12px;
            padding: 0 8px;
            margin: 0 6px 6px 0;
        }
        .box-main {
            margin-top: 10px;
            padding-top: 5px;
        }
    </style>
</head>
<body class="gray-bg">

<div class="wrapper">
    <div id="pb1"></div>
    <div id="overlayBox" class="overlayBox">
        <div class="process-title"><a th:text="${processName}"></a></div>
        <div id="diagramHolder" class="diagramHolder"></div>
    </div>
    <div class="infoBox" >
        <div id="process_info_div">
            <p class="config-title">流程信息</p>
            <div class="ibox float-e-margins">
                <div class="info-line">
                    <div class="col-sm-3">流程编号</div>
                    <div class="col-sm-9" th:text="${processId}"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">部署编号</div>
                    <div class="col-sm-9" th:text="${deploymentId}"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">流程名称</div>
                    <div class="col-sm-9" th:text="${processName}"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">流程KEY</div>
                    <div class="col-sm-9" th:text="${processKey}"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">流程版本</div>
                    <div class="col-sm-9" th:text="${processVersion}"></div>
                </div>
            </div>
        </div>

        <div id="usertask_conifg_div" style="display: none;">
            <p class="config-title" >节点配置【<span id="usertask_conifg_title"></span>】</p>
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>节点人员</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link"><i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="alert alert-warning" id="span_div">
                        未配置节点人员
                    </div>
                    <a class="btn btn-success btn-block btn-outline" data-toggle="modal" data-target="#user_scope_model">
                        设置节点人员
                    </a>
                </div>
            </div>

            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>节点属性</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link"><i class="fa fa-chevron-down"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content" style="display: none;">
                </div>
            </div>

            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>节点按钮</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link"><i class="fa fa-chevron-down"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content" style="display: none;">
                </div>
            </div>
        </div>

        <div id="servicetask_conifg_div" style="display: none">
            <p class="config-title" id="servicetask_conifg_title">节点配置 []</p>
        </div>

        <div id="gateway_conifg_div" style="display: none">
            <p class="config-title" id="gateway_conifg_title">网关配置</p>
        </div>

        <div id="event_info_div" style="display: none">
            <p class="config-title">事件信息</p>
            <div class="ibox float-e-margins">
                <div class="info-line">
                    <div class="col-sm-3">ID</div>
                    <div class="col-sm-9" id="event_id"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">名称</div>
                    <div class="col-sm-9" id="event_name"></div>
                </div>
            </div>
        </div>

        <div id="line_info_div" style="display: none">
            <p class="config-title">连线信息</p>
            <div class="ibox float-e-margins">
                <div class="info-line">
                    <div class="col-sm-3">ID</div>
                    <div class="col-sm-9" id="line_id"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">源ID</div>
                    <div class="col-sm-9" id="source_line_id"></div>
                </div>
                <div class="info-line">
                    <div class="col-sm-3">目标ID</div>
                    <div class="col-sm-9" id="destination_line_id"></div>
                </div>
            </div>
        </div>

        <button type="button" style="display: none" class="btn btn-block btn-primary" id="config_save_btn">
            <i class="fa fa-check"></i>保存
        </button>
    </div>

</div>

<!-- 节点人员设置模态框 -->
<div class="modal inmodal fade" id="user_scope_model" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                </button>
                <h4 class="modal-title">节点人员设置【<span id="user_scope_model_title"></span>】</h4>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;" id="user_scope_action">
                    <a class="btn btn-success btn-outline" onclick="toUserChoose()">添加人员</a>
                    <a class="btn btn-success btn-outline" onclick="toRoleChoose()">添加角色</a>
                    <a class="btn btn-success btn-outline">添加岗位</a>
                </div>
                <table id="taskUsers_table" class="table table-hover table-bordered hide" style="background-color: #ffffff">
                    <thead>
                        <tr>
                            <th>
                                <div class="th-inner ">用户名称</div>
                            </th>
                            <th>
                                <div class="th-inner ">登录名称</div>
                            </th>
                            <th>
                                <div class="th-inner ">所属部门</div>
                            </th>
                            <th style="text-align: center; ">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="no-records-found">
                            <td colspan="4">没有数据</td>
                        </tr>
                    </tbody>
                </table>

                <table id="taskRoles_table" class="table table-hover table-bordered hide" style="background-color: #ffffff">
                    <thead>
                    <tr>
                        <th>
                            <div class="th-inner ">角色编号</div>
                        </th>
                        <th>
                            <div class="th-inner ">角色名称</div>
                        </th>
                        <th>
                            <div class="th-inner ">权限标识</div>
                        </th>
                        <th style="text-align: center; ">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="no-records-found">
                        <td colspan="4">没有数据</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 人员选择模态框 -->
<div class="modal inmodal fade" id="user_select_model" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="width: 1200px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                </button>
                <h4 class="modal-title">选择人员</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                <div class="col-md-3">
                    <div class="box box-main">
                        <div class="box-header">
                            <div class="box-title">
                                <i class="fa icon-grid"></i> 组织机构
                            </div>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" id="btnExpand" title="展开" style="display:none;"><i class="fa fa-chevron-up"></i></button>
                                <button type="button" class="btn btn-box-tool" id="btnCollapse" title="折叠"><i class="fa fa-chevron-down"></i></button>
                                <button type="button" class="btn btn-box-tool" id="btnRefresh" title="刷新部门"><i class="fa fa-refresh"></i></button>
                            </div>
                        </div>
                        <div class="ui-layout-content">
                            <div id="tree" class="ztree"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="container-div">
                        <div class="row">
                            <div class="col-sm-12 search-collapse">
                                <form id="user-form">
                                    <input type="hidden" id="deptId" name="deptId">
                                    <input type="hidden" id="parentId" name="parentId">
                                    <div class="select-list">
                                        <ul>
                                            <li>
                                                登录名称：<input type="text" name="loginName"/>
                                            </li>
                                            <li>
                                                手机号码：<input type="text" name="phonenumber"/>
                                            </li>
                                            <li>
                                                用户状态：<select name="status" th:with="type=${@dict.getType('sys_normal_disable')}">
                                                <option value="">所有</option>
                                                <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                                            </select>
                                            </li>
                                            <li class="select-time">
                                                <label>创建时间： </label>
                                                <input type="text" class="time-input" id="startTime" placeholder="开始时间" name="params[beginTime]"/>
                                                <span>-</span>
                                                <input type="text" class="time-input" id="endTime" placeholder="结束时间" name="params[endTime]"/>
                                            </li>
                                            <li>
                                                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                                            </li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                            <div class="col-sm-12 select-table table-striped">
                                <table id="users-table"></table>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 角色选择模态框 -->
<div class="modal inmodal fade" id="role_select_model" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="width: 1200px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                </button>
                <h4 class="modal-title">选择角色</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="container-div">
                            <div class="row">
                                <div class="col-sm-12 search-collapse">
                                    <form id="role-form">
                                        <div class="select-list">
                                            <ul>
                                                <li>
                                                    角色名称：<input type="text" name="roleName"/>
                                                </li>
                                                <li>
                                                    权限字符：<input type="text" name="roleKey"/>
                                                </li>
                                                <li>
                                                    <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search('role-form', 'roles-table')"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                    <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset('role-form', 'roles-table')"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-sm-12 select-table table-striped">
                                    <table id="roles-table"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/bootstrap.min.js}"></script>
<!-- 遮罩层 -->
<script th:src="@{/ajax/libs/blockUI/jquery.blockUI.js}"></script>
<script th:src="@{/ajax/libs/iCheck/icheck.min.js}"></script>
<script th:src="@{/ajax/libs/layer/layer.min.js}"></script>
<script th:src="@{/ajax/libs/layui/layui.js}"></script>
<script th:src="@{/ruoyi/js/common.js?v=4.1.0}"></script>
<script th:src="@{/ruoyi/js/ry-ui.js?v=4.1.0}"></script>
<!-- bootstrap-table 表格插件 -->
<script th:src="@{/ajax/libs/bootstrap-table/bootstrap-table.min.js}"></script>
<script th:src="@{/ajax/libs/bootstrap-table/locale/bootstrap-table-zh-CN.min.js}"></script>
<script th:src="@{/ajax/libs/bootstrap-table/extensions/mobile/bootstrap-table-mobile.js}"></script>
<script th:src="@{/ajax/libs/bootstrap-table/extensions/toolbar/bootstrap-table-toolbar.min.js}"></script>
<script th:src="@{/ajax/libs/bootstrap-table/extensions/columns/bootstrap-table-fixed-columns.js}"></script>

<th:block th:include="include :: ztree-js" />

<script th:inline="javascript"> var ctx = [[@{/}]]; </script>
<script language='javascript'>
    var DiagramGenerator = {};
    var pb1;
    //流程id
    var processDefinitionId = '[[${processId}]]';
    //流程userTask、serviceTask配置信息
    var processTaskConfig = [];
    //当前操作task序号
    var cur_opt_task_index = null;


    $(document).ready(function(){
        //配置框收起
        $(".ibox-title").click(function() {
            var div_ibox = $(this).closest("div.ibox"),
                e = $(this).find("i"),
                i = div_ibox.find("div.ibox-content");
            i.slideToggle(200);
            e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down");
            div_ibox.toggleClass("").toggleClass("border-bottom");
            setTimeout(function() {
                div_ibox.resize();
            }, 50);
        });

        $('#user_scope_action').find('a').click(function () {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
        });

        getProcessConfigData();
        queryUserList();
        queryDeptTree();
        queryRolesList();

        //保存按钮
        $("#config_save_btn").click(function () {
            var taskName = processTaskConfig[cur_opt_task_index].taskName;
            $.modal.confirm("确定变更【" + taskName + "】节点配置吗?", function () {
                /* 这里使用 JSON.parse(JSON.stringify(obj)) 是为了防止修改原来的信息，
                    否则processTaskConfig[cur_opt_task_index]的taskUsers也会被修改*/
                let data = JSON.parse(JSON.stringify(processTaskConfig[cur_opt_task_index]));
                if($.common.isNotEmpty(data.taskUsers)) {
                    var arr = [];
                    $.each(data.taskUsers, function (i, user) {
                        arr.push(user.userId);
                    });
                    data.taskUsers = arr.join(',');
                }
                if($.common.isNotEmpty(data.taskRoles)) {
                    var arr = [];
                    $.each(data.taskRoles, function (i, role) {
                        arr.push(role.roleId);
                    });
                    data.taskRoles = arr.join(',');
                }
                if($.common.isNotEmpty(data.taskPosts)) {
                    var arr = [];
                    $.each(data.taskPosts, function (i, post) {
                        arr.push(post.postId);
                    });
                    data.taskPosts = arr.join(',');
                }
                $.ajax({
                    url: ctx + "activiti/process/saveUserTaskConfig",
                    type: "post",
                    dataType: "json",
                    data: data,
                    error : function(request) {
                        $.modal.alertError("系统错误");
                    },
                    success : function(data) {
                        debugger
                        if (data.code == web_status.SUCCESS) {
                            $.modal.alertSuccess("【" + taskName + "】节点保存成功！");
                        } else if (data.code == web_status.WARNING) {
                            $.modal.alertWarning(data.msg)
                        } else {
                            $.modal.alertError("【" + taskName + "】节点保存异常！");
                        }
                    }
                });
            });
        })

    });

    /**
     *  用户任务处理人范围设置
     **/
    function setUserTaskAssigneeScope(taskKey, type, name) {
        $('#usertask_conifg_title').text(name);
        $('#user_scope_model_title').text(name);
        $('#usertask_conifg_div').show();
        $('#config_save_btn').show();
        $("#taskUsers_table").addClass('hide').children("tbody").html('<tr class="no-records-found"><td colspan="4">没有数据</td></tr>');
        $("#taskRoles_table").addClass('hide').children("tbody").html('<tr class="no-records-found"><td colspan="4">没有数据</td></tr>');
        $('#span_div').html('未配置节点人员');
        $('#user_scope_action').find('a').removeClass('active')
        $.each(processTaskConfig, function (index, task) {
            if(task.taskKey == taskKey) {
                cur_opt_task_index = index;
                var taskUsers = task.taskUsers;
                if($.common.isNotEmpty(taskUsers)) {
                    $('#taskUsers_table').removeClass('hide');
                    $('#user_scope_action').find('a:eq(0)').addClass('active');
                    taskUsers = typeof (task.taskUsers) == "object" ? task.taskUsers : eval('(' + task.taskUsers + ')');
                    processTaskConfig[index].taskUsers = taskUsers;
                    $.each(taskUsers, function (j, user) {
                        userTrAdd(user);
                        if($('#span_div').find('span').length == 0) {
                            $('#span_div').empty();
                        }
                        $('#span_div').append('<span class="selected_user" data-item-id="'+ user.userId +'">'+ user.userName +'</span>');
                    });
                }

                var taskRoles = task.taskRoles;
                if($.common.isNotEmpty(taskRoles)) {
                    $('#taskRoles_table').removeClass('hide');
                    $('#user_scope_action').find('a:eq(1)').addClass('active');
                    taskRoles = typeof (task.taskRoles) == "object" ? task.taskRoles : eval('(' + task.taskRoles + ')');
                    processTaskConfig[index].taskRoles = taskRoles;
                    $.each(taskRoles, function (j, role) {
                        roleTrAdd(role);
                        if($('#span_div').find('span').length == 0) {
                            $('#span_div').empty();
                        }
                        $('#span_div').append('<span class="selected_role" data-item-id="'+ role.roleId +'">'+ role.roleName +'</span>');
                    });
                }
            }
        });
    }

    function userTrAdd(user) {
        if($("#taskUsers_table tbody").children('tr:eq(0)').hasClass('no-records-found')) {
            $("#taskUsers_table tbody").children('tr:eq(0)').remove();
        }
        var tr = "<tr>" +
            "<td>" + user.userName + "</td>" +
            "<td>" + user.loginName + "</td>" +
            "<td>" + user.dept.deptName + "</td>" +
            "<td style=\"text-align: center; \">" +
            "<a class='btn btn-danger btn-xs' href='javascript:void(0)' data-cur-index='" + cur_opt_task_index + "'  data-item-id='" + user.userId + "' onclick='deleteUser($(this));'><i class=\"fa fa-remove\">删除</a>" +
            "</td>" +
            "</tr>";
        $("#taskUsers_table tbody").append(tr);
    }

    /** 添加审批人员 **/
    function addUser(obj) {
        var user = JSON.parse(decodeURI(obj));
        var item = {};
        item.userId = user.userId;
        item.userName = user.userName;
        item.loginName = user.loginName;
        item.dept = {
            deptName:user.dept.deptName
        }
        var i = processTaskConfig[cur_opt_task_index].taskUsers != null ? processTaskConfig[cur_opt_task_index].taskUsers.length : 0;
        if (i == 0) {
            var array = [];
            array.push(item);
            processTaskConfig[cur_opt_task_index].taskUsers = array;
        } else {
            processTaskConfig[cur_opt_task_index].taskUsers.push(item);
        }
        userTrAdd(item);
        if($('#span_div').find('span').length == 0) {
            $('#span_div').empty();
        }
        $('#span_div').append('<span class="selected_user" data-item-id="'+ user.userId +'">'+ user.userName +'</span>');
        $.table.refresh('users-table');
    }

    //删除审批人员
    function deleteUser(obj) {
        var userId = $(obj).data('item-id');
        $.modal.confirm("确定删除当前审批人员吗？", function() {
            var taskUsers = processTaskConfig[cur_opt_task_index].taskUsers;
            $.each(taskUsers, function (i, v) {
                if (v.userId == userId) {
                    taskUsers.splice(i, 1);
                    return false;
                }
            })
            processTaskConfig[cur_opt_task_index].taskUsers = taskUsers;

            var aList = $("#taskUsers_table tbody").find('a');
            $.each(aList, function (i, a) {
                if($(a).data('item-id') == userId) {
                    $(a).closest('tr').remove();
                    return;
                }
            })
            if($("#taskUsers_table tbody").find('tr').length == 0) {
                $("#taskUsers_table tbody").append('<tr class="no-records-found"><td colspan="4">没有数据</td></tr>')
            }

            var spans = $("#span_div").find("span");
            $.each(spans, function (i, v) {
                if (userId == $(v).data("item-id")) {
                    $(this).remove();
                }
            })
            if($('#span_div').find('span').length == 0) {
                $("#span_div").html('未配置节点人员');
            }

            $.table.refresh('users-table');

        });
    }

    /** 添加审批角色 **/
    function addRole(obj) {
        let role = JSON.parse(decodeURI(obj));
        let item = {};
        item.roleId = role.roleId;
        item.roleName = role.roleName;
        item.roleKey = role.roleKey;
        var i = processTaskConfig[cur_opt_task_index].taskRoles != null ? processTaskConfig[cur_opt_task_index].taskRoles.length : 0;
        if (i == 0) {
            var array = [];
            array.push(item);
            processTaskConfig[cur_opt_task_index].taskRoles = array;
        } else {
            processTaskConfig[cur_opt_task_index].taskRoles.push(item);
        }
        roleTrAdd(item);
        if($('#span_div').find('span').length == 0) {
            $('#span_div').empty();
        }
        $('#span_div').append('<span class="selected_role" data-item-id="'+ role.roleId +'">'+ role.roleName +'</span>');
        $.table.refresh('roles-table');
    }

    function roleTrAdd(role) {
        if($("#taskRoles_table tbody").children('tr:eq(0)').hasClass('no-records-found')) {
            $("#taskRoles_table tbody").children('tr:eq(0)').remove();
        }
        var tr = "<tr>" +
            "<td>" + role.roleId + "</td>" +
            "<td>" + role.roleName + "</td>" +
            "<td>" + role.roleKey + "</td>" +
            "<td style=\"text-align: center; \">" +
            "<a class='btn btn-danger btn-xs' href='javascript:void(0)' data-cur-index='" + cur_opt_task_index + "'  data-item-id='" + role.roleId + "' onclick='deleteRole($(this));'><i class=\"fa fa-remove\">删除</a>" +
            "</td>" +
            "</tr>";
        $("#taskRoles_table tbody").append(tr);
    }

    //删除审批角色
    function deleteRole(obj) {
        var roleId = $(obj).data('item-id');
        $.modal.confirm("确定删除当前审批角色吗？", function() {
            var taskRoles = processTaskConfig[cur_opt_task_index].taskRoles;
            $.each(taskRoles, function (i, v) {
                if (v.roleId == roleId) {
                    taskRoles.splice(i, 1);
                    return false;
                }
            })
            processTaskConfig[cur_opt_task_index].taskRoles = taskRoles;

            var aList = $("#taskRoles_table tbody").find('a');
            $.each(aList, function (i, a) {
                if($(a).data('item-id') == roleId) {
                    $(a).closest('tr').remove();
                    return;
                }
            })
            if($("#taskRoles_table tbody").find('tr').length == 0) {
                $("#taskRoles_table tbody").append('<tr class="no-records-found"><td colspan="4">没有数据</td></tr>')
            }

            var spans = $("#span_div").find("span");
            $.each(spans, function (i, v) {
                if (roleId == $(v).data("item-id")) {
                    $(this).remove();
                }
            })
            if($('#span_div').find('span').length == 0) {
                $("#span_div").html('未配置节点人员');
            }

            $.table.refresh('roles-table');

        });
    }

    /** 连线信息 **/
    function showLineInfo(object) {
        $('.infoBox').children('div').hide();
        var contextObject = object.data("contextObject");
        //源ID
        var sourceActivityId = contextObject.sourceActivityId;
        //目标ID
        var destinationActivityId = contextObject.destinationActivityId;
        var id = contextObject.id;
        $('#line_id').text(id);
        $('#source_line_id').text(sourceActivityId)
        $('#destination_line_id').text(destinationActivityId)
        $('#config_save_btn').hide();
        $('#line_info_div').show();
    }

    /** 用户列表 **/
    function queryUserList() {
        var options = {
            id: "users-table",
            url: ctx + "system/user/list",
            sortName: "createTime",
            sortOrder: "desc",
            modalName: "用户",
            columns: [{
                checkbox: true
            },
                {
                    field: 'userId',
                    title: '用户ID'
                },
                {
                    field: 'loginName',
                    title: '登录名称',
                    sortable: true
                },
                {
                    field: 'userName',
                    title: '用户名称'
                },
                {
                    field: 'dept.deptName',
                    title: '部门'
                },
                {
                    field: 'email',
                    title: '邮箱',
                    visible: false
                },
                {
                    field: 'phonenumber',
                    title: '手机'
                },
                {
                    title: '用户状态',
                    align: 'center',
                    formatter: function (value, row, index) {
                        if (row.status == 1) {
                            return '<span class="label label-warning btn-rounded">停用</span>';
                        } else {
                            return '<span class="label label-info btn-rounded">正常</span>';
                        }
                    }
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    sortable: true
                },
                {
                    field: 'userId',
                    title: '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var temp = encodeURI(JSON.stringify(row));
                        var html = '<a class="btn btn-success btn-xs" href="javascript:void(0)" onclick="addUser(\'' + temp + '\')"><i class="fa fa-check"></i>选择</a> ';
                        if($.common.isNotEmpty(cur_opt_task_index)) {
                            var taskUsers = processTaskConfig[cur_opt_task_index].taskUsers;
                            if($.common.isNotEmpty(taskUsers)){
                                $.each(taskUsers, function (i, user) {
                                    if(user.userId == value){
                                        html = '<a class="btn btn-danger btn-xs" href="javascript:void(0)"  data-item-id="' + user.userId + '"' +
                                            ' onclick="deleteUser($(this))"><i class="fa fa-times"></i>删除</a> ';
                                        return;
                                    }
                                })
                            }
                        }
                        return html;
                    }
                }]
        };
        $.table.init(options);
    }
    /** 部门树 **/
    function queryDeptTree() {
        var url = ctx + "system/dept/treeData";
        var options = {
            url: url,
            expandLevel: 2,
            onClick : zOnClick
        };
        $.tree.init(options);

        function zOnClick(event, treeId, treeNode) {
            $("#deptId").val(treeNode.id);
            $("#parentId").val(treeNode.pId);
            $.table.search('user-form', 'users-table');
        }
    }

    /** 角色列表 **/
    function queryRolesList() {
        var options = {
            id: "roles-table",
            url: ctx + "system/role/list",
            sortName: "roleSort",
            modalName: "角色",
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            columns: [
                {
                    field: 'roleId',
                    title: '角色编号'
                },
                {
                    field: 'roleName',
                    title: '角色名称',
                    sortable: true
                },
                {
                    field: 'roleKey',
                    title: '权限字符',
                    sortable: true
                },
                {
                    field: 'roleSort',
                    title: '显示顺序',
                    sortable: true
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    sortable: true
                },
                {
                    field: 'roleId',
                    title: '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var temp = encodeURI(JSON.stringify(row));
                        var html = '<a class="btn btn-success btn-xs" href="javascript:void(0)" onclick="addRole(\'' + temp + '\')"><i class="fa fa-check"></i>添加</a> ';
                        if($.common.isNotEmpty(cur_opt_task_index)) {
                            var taskRoles = processTaskConfig[cur_opt_task_index].taskRoles;
                            if($.common.isNotEmpty(taskRoles)){
                                $.each(taskRoles, function (i, role) {
                                    if(role.roleId == value){
                                        html = '<a class="btn btn-danger btn-xs" href="javascript:void(0)"  data-item-id="' + role.roleId + '"' +
                                            ' onclick="deleteRole($(this))"><i class="fa fa-times"></i>删除</a> ';
                                        return;
                                    }
                                })
                            }
                        }
                        return html;
                    }
                }]
        };
        $.table.init(options);
    }

    $('#btnExpand').click(function() {
        $._tree.expandAll(true);
        $(this).hide();
        $('#btnCollapse').show();
    });

    $('#btnCollapse').click(function() {
        $._tree.expandAll(false);
        $(this).hide();
        $('#btnExpand').show();
    });

    $('#btnRefresh').click(function() {
        queryDeptTree();
    });

    /** 添加人员按钮点击事件 **/
    function toUserChoose() {
        var taskRoles = processTaskConfig[cur_opt_task_index].taskRoles;
        var taskPosts = processTaskConfig[cur_opt_task_index].taskPosts;
        var msg = null;
        if($.common.isNotEmpty(taskRoles)){
            msg = '角色';
        }
        if($.common.isNotEmpty(taskPosts)){
            msg = '岗位';
        }
        $.table.refresh('users-table');
        $('#taskUsers_table').removeClass('hide').siblings('.table').addClass('hide');
        if(msg == null) {
            $.table.refresh('users-table');
            $('#user_scope_model').modal('hide');
            $('#user_select_model').modal('show');
        } else {
            $.modal.confirm('添加人员会清除已配置'+msg+'信息,确定继续？', function () {
                processTaskConfig[cur_opt_task_index].taskRoles = null
                processTaskConfig[cur_opt_task_index].taskPosts = null;
                $("#span_div").html('未配置节点人员');
                $('#user_scope_model').modal('hide');
                $('#user_select_model').modal('show');
            });
        }

    }

    /** 添加角色按钮点击事件 **/
    function toRoleChoose() {
        var taskUsers = processTaskConfig[cur_opt_task_index].taskUsers;
        var taskPosts = processTaskConfig[cur_opt_task_index].taskPosts;
        var msg = null;
        if($.common.isNotEmpty(taskUsers)){
            msg = '人员';
        }
        if($.common.isNotEmpty(taskPosts)){
            msg = '岗位';
        }
        $.table.refresh('roles-table');
        $('#taskRoles_table').removeClass('hide').siblings('.table').addClass('hide');
        if(msg == null) {
            $('#user_scope_model').modal('hide');
            $('#role_select_model').modal('show');
        } else {
            $.modal.confirm('添加角色会清除已配置'+msg+'信息,确定继续？', function () {
                processTaskConfig[cur_opt_task_index].taskUsers = null
                processTaskConfig[cur_opt_task_index].taskPosts = null;
                $("#span_div").html('未配置节点人员');
                $('#user_scope_model').modal('hide');
                $('#role_select_model').modal('show');
            });
        }

    }

    /**
     * 流程配置数据初始化
     */
    function getProcessConfigData() {
        $.modal.loading("数据加载中，请稍后...");
        $.ajax({
            cache : true,
            type : "GET",
            url : ctx + "activiti/process/getProcessConfigData",
            data : {
                "processId": processDefinitionId
            },
            async : false,
            error : function(request) {
                $.modal.alertError("系统错误");
            },
            success : function(data) {
                if (data.code == web_status.SUCCESS) {
                    initGraph();
                    var configInfo = data.data;
                    processTaskConfig = configInfo.processTaskConfig;
                } else if (data.code == web_status.WARNING) {
                    $.modal.alertWarning(data.msg)
                } else {
                    $.modal.alertError(data.msg);
                }
            }
        });
    }

    /**
     * 流程图初始化
     */
    function initGraph() {
        pb1 = new $.ProgressBar({
            boundingBox: '#pb1',
            label: '',
            on: {
                complete: function() {
                    // this.set('label', 'complete!');
                    // if (processInstanceId) {
                    //     ProcessDiagramGenerator.drawHighLights(processInstanceId);
                    // }

                    setTimeout(function () {
                        window.zoomTiger = svgPanZoom('.diagramHolder svg', {
                            zoomEnabled: true,
                            controlIconsEnabled: true,
                            fit: true,
                            center: true
                        });
                        $.modal.closeLoading();
                    }, 1000)

                },
                valueChange: function(e) {
                    // this.set('label', e.newVal + '%');
                }
            },
            value: 0
        });

        ProcessDiagramGenerator.options = {
            diagramBreadCrumbsId: "diagramBreadCrumbs",
            diagramHolderId: "diagramHolder",
            diagramInfoId: "diagramInfo",
            on: {
                click: function(canvas, element, contextObject){
                    var mouseEvent = this;
                    var type = contextObject.getProperty("type");
                    var name = contextObject.getProperty("name");
                    var id = contextObject.id;

                    $('.infoBox').children('div,button').hide();

                    //用户任务
                    if (type == "userTask") {
                        //用户任务
                        setUserTaskAssigneeScope(id, type, name);
                    }
                    //排它网关
                    else if (type == "exclusiveGateway") {
                        $('#gateway_conifg_div').show();
                        $('#config_save_btn').show();
                        //加载网关
                        selectGateWay(id, type, name);

                    }
                    //服务节点
                    else if (type == "serviceTask") {
                        $('#servicetask_conifg_div').show();
                        $('#config_save_btn').show();
                        selectServiceTask(id, type, name);

                    }
                    //事件
                    else {
                        $('#event_info_div').show();
                        $("#event_id").html(id);
                        $("#event_name").html(name);
                    }

                },
                rightClick: function(canvas, element, contextObject){
                },
                over: function(canvas, element, contextObject){
                },
                out: function(canvas, element, contextObject){
                }
            }
        };

        var baseUrl = window.document.location.protocol + "//" + window.document.location.host + "/";
        var shortenedUrl = window.document.location.href.replace(baseUrl, "");
        baseUrl = baseUrl + shortenedUrl.substring(0, shortenedUrl.indexOf("/"));

        ActivitiRest.options = {
            processInstanceHighLightsUrl: "",
            processDefinitionUrl: baseUrl + "/process/process-definition/{processDefinitionId}",
            processDefinitionByKeyUrl: ""
        };

        if (processDefinitionId) {
            ProcessDiagramGenerator.drawDiagram(processDefinitionId);

        } else {
            alert("processDefinitionId parameter is required");
        }
    }

</script>

</body>
</html>